<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.9, viewport-fit=cover" />
<title>Video Feed — Bottom Sheet “관심없음”</title>
<style>
  html, body { margin:0; padding:0; height:100vh; background:#000; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, sans-serif; }
  #container {
    height: calc(var(--vh, 1vh) * 100);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: y mandatory;
  }
  #container::-webkit-scrollbar{ display:none; }

  .video {
    position: relative;
    scroll-snap-align: end;
    height: 100vh; max-width: 520px; margin: 0 auto; overflow: hidden; color:#fff;
  }
  .video video.video-bg {
    position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; pointer-events: none;
  }
  .video > * { position: relative; z-index: 1; }

  .top { display:flex; justify-content: space-between; padding: 12px 14px; }
  .body { height: 100%; display:flex; align-items:flex-end; gap:14px; padding: 14px; }
  .left { display:flex; flex-direction:column; gap:8px; width:70%; }
  .id { display:flex; gap:8px; align-items:center; }
  .ellipse { width: 30px; height:30px; border-radius: 50%; background: rgba(255,255,255,.85); }
  .id-text{ font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.5); }
  .title-text { font-size: 16px; font-weight: 700; text-shadow:0 1px 2px rgba(0,0,0,.5); }
  .music { display:flex; gap:8px; align-items:center; opacity:.9; }

  .right { display:flex; flex-direction:column; gap:10px; margin-left:auto; align-items:center; }
  .button {
    display:flex; gap:6px; align-items:center;
    padding: 8px 10px; border:0; border-radius:12px;
    background: rgba(0,0,0,.35); color:#fff; cursor:pointer;
    backdrop-filter: blur(3px);
  }
  .button:active{ transform: translateY(1px); }
  .text-wrapper { font-size: 12px; font-weight: 800; }

  #loading { text-align:center; padding:10px; background:#fff; color:#333; font-size:.9rem; }
  .empty { color:#fff; text-align:center; padding:28px; max-width:720px; margin: 0 auto; white-space:pre-line; line-height:1.5; }

  /* Bottom Sheet */
  .sheet-backdrop { position: fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:9998; }
  .sheet {
    position: fixed; left:0; right:0; bottom:0; transform: translateY(100%);
    background:#111; color:#fff; z-index:9999;
    border-top-left-radius:16px; border-top-right-radius:16px; box-shadow:0 -10px 30px rgba(0,0,0,.4);
    transition: transform .28s ease; padding-bottom: env(safe-area-inset-bottom);
  }
  .sheet-header { padding: 14px 16px 4px; }
  .sheet-drag { width:44px; height:4px; border-radius:999px; margin:6px auto 10px; background:rgba(255,255,255,.25); }
  .sheet-title { font-size:16px; font-weight:800; }
  .sheet-list { display:grid; gap:8px; padding:12px 16px 16px; max-height:min(60vh,520px); overflow-y:auto; }
  .sheet-item { text-align:left; width:100%; background:#1a1a1a; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px; font-size:14px; font-weight:600; cursor:pointer; }
  .sheet-actions{ display:flex; gap:10px; padding:10px 16px 16px; }
  .btn-cancel { flex:1; padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:800; background:#2a2a2a; color:#fff; }

  body.sheet-open { overflow:hidden; touch-action:none; }
  body.sheet-open .sheet { transform: translateY(0%); }
  body.sheet-open .sheet-backdrop { opacity:1; pointer-events:auto; }
</style>
</head>
<body>
  <div id="container">
    <!-- 카드 템플릿 -->
    <article class="video" id="video-template" data-category="">
      <div class="top"><div style="opacity:.9"></div><div style="opacity:.9"></div></div>
      <div class="body">
        <div class="left">
          <div class="id"><div class="ellipse"></div><div class="id-text"></div></div>
          <div class="title-text"></div>
          <div class="music"><span>🎵</span><div class="music-text"></div></div>
        </div>
        <div class="right">
          <button class="button"><span>👍</span><div class="text-wrapper">LIKE</div></button>
          <button class="button"><span>👎</span><div class="text-wrapper">싫어요</div></button>
          <button class="button btn-hide-category"><span>🚫</span><div class="text-wrapper">관심없음</div></button>
        </div>
      </div>
    </article>
    <div id="loading">로딩 중...</div>
  </div>

  <!-- Bottom Sheet -->
  <div class="sheet-backdrop" id="sheet-backdrop" aria-hidden="true"></div>
  <section class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheet-title">
    <div class="sheet-drag"></div>
    <header class="sheet-header"><div id="sheet-title" class="sheet-title">Tell us why you're not interested.</div></header>
    <div class="sheet-list" id="sheet-list"></div>
    <div class="sheet-actions"><button class="btn-cancel" id="btn-cancel" type="button">취소</button></div>
  </section>

<script>
/* ---------- viewport fix ---------- */
function setRealHeight(){ const vh = window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
addEventListener('resize', setRealHeight); addEventListener('load', setRealHeight);

/* ---------- 고정 카테고리 (네가 준 목록 그대로) ---------- */
const CATEGORY_FILES = [
  'hindi.csv',
  'ive.csv',
  'kdh.csv',
  'overwatch.csv',
  'promise9.csv',
  'sahoor.csv',
  'thai.csv',
  'valorant.csv'
];

/* ---------- DOM refs ---------- */
const container = document.getElementById('container');
const loading = document.getElementById('loading');
const template = document.getElementById('video-template');
template.removeAttribute('id'); // hide template
container.removeChild(template);

/* ---------- CSV parser (따옴표/쉼표 안전) ---------- */
function parseCSV(text){
  text = (text || '').replace(/^\uFEFF/, '');
  const rows = [];
  let i=0, field='', row=[], inQ=false;
  for(; i<text.length; i++){
    const c = text[i];
    if(c === '"'){
      if(inQ && text[i+1] === '"'){ field += '"'; i++; }
      else inQ = !inQ;
    } else if(c === ',' && !inQ){
      row.push(field); field='';
    } else if(c === '\n' && !inQ){
      row.push(field); rows.push(row); field=''; row=[];
    } else { field += c; }
  }
  if(field.length || row.length){ row.push(field); rows.push(row); }

  if(!rows.length) return [];
  const header = rows.shift().map(h => (h||'').trim());
  return rows
    .filter(r => r.some(cell => (cell||'').trim() !== ''))
    .map(cols => {
      const obj = {};
      header.forEach((h,idx)=> obj[h] = (cols[idx] ?? '').trim());
      return obj;
    });
}

/* ---------- helpers ---------- */
function get(row, keys){
  for(const k of keys){ if(row[k]) return row[k]; }
  const lower = Object.create(null);
  for(const k in row){ lower[k.toLowerCase()] = k; }
  for(const key of keys){
    const k2 = lower[String(key).toLowerCase()];
    if(k2 && row[k2]) return row[k2];
  }
  return '';
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ---------- state ---------- */
const permanentlyHidden = new Set(); // 유저가 숨긴 카테고리
let allVideosCache = [];

/* ---------- 로드 ---------- */
async function loadAll(){
  try{
    const results = await Promise.all(CATEGORY_FILES.map(async (file)=>{
      const cat = file.replace(/\.csv$/,'');
      try{
        const res = await fetch(file);
        if(!res.ok) throw new Error(`${file} 로드 실패`);
        const text = await res.text();
        const rows = parseCSV(text).map(r => ({...r, _category: cat}));
        return shuffle(rows);
      }catch(e){
        console.warn(e.message);
        return [];
      }
    }));
    allVideosCache = shuffle(results.flat());
    reloadVideos();
  }catch(e){
    console.error(e);
    loading.textContent = '데이터를 불러오지 못했습니다.';
  }
}

/* ---------- 카드 ---------- */
function createCard(row){
  const cat = row._category || '';
  if(permanentlyHidden.has(cat)) return null;

  // 비디오 src 추출 (여러 헤더명 지원)
  const src = get(row, ['MP4 URL','mp4','url','video','source','Video','video_url','download_url']);
  if(!src) return null; // 소스 없으면 스킵

  const card = template.cloneNode(true);
  card.dataset.category = cat;

  const vid = document.createElement('video');
  vid.className = 'video-bg';
  vid.src = src;
  vid.autoplay = true; vid.loop = true; vid.playsInline = true; vid.muted = true; // 소리 기본 꺼둠(중복재생 방지)
  card.prepend(vid);

  const idt = card.querySelector('.id-text'); if(idt) idt.textContent = get(row, ['ID','id','channel','creator']) || cat.toUpperCase();
  const tt  = card.querySelector('.title-text'); if(tt) tt.textContent = get(row, ['TITLE','title','caption']) || 'Untitled';
  const mt  = card.querySelector('.music-text'); if(mt) mt.textContent = get(row, ['MUSIC','music','audio']) || '';

  // 관심없음 버튼 → 바텀시트
  const btnHide = card.querySelector('.btn-hide-category');
  btnHide?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openSheet(cat); });

  return card;
}

/* ---------- 렌더 ---------- */
function reloadVideos(){
  container.innerHTML = '';
  let count = 0;
  for(const row of allVideosCache){
    if(permanentlyHidden.has(row._category)) continue;
    const card = createCard(row);
    if(card){ container.appendChild(card); count++; }
  }
  if(!count){
    container.innerHTML = '<div class="empty">표시할 영상이 없습니다.\nCSV 파일이 비어 있거나, 비디오 URL 컬럼명이 다를 수 있어요.\n(지원 컬럼: MP4 URL / mp4 / url / video / source ...)</div>';
  }
  loading.style.display = 'none';
}

/* ---------- 카테고리 숨기기 ---------- */
function hideCategory(cat){
  if(!cat) return;
  permanentlyHidden.add(cat);
  [...container.querySelectorAll(`.video[data-category="${cat}"]`)].forEach(el=>{
    const v = el.querySelector('video'); try{ v?.pause(); v && (v.src=''); }catch(e){}
    el.remove();
  });
  reloadVideos();
}

/* ---------- Bottom Sheet ---------- */
const sheet         = document.getElementById('sheet');
const sheetBackdrop = document.getElementById('sheet-backdrop');
const sheetList     = document.getElementById('sheet-list');
const btnCancel     = document.getElementById('btn-cancel');

const REASONS = [
  "I see this too often",
  "Not relevant to me",
  "I don't like this creator",
  "I don’t like this topic",
  "Misleading or clickbait",
  "Low quality video",
  "Offensive content",
  "Other"
];
REASONS.forEach(r=>{
  const b = document.createElement('button');
  b.type = 'button'; b.className = 'sheet-item'; b.textContent = r;
  b.addEventListener('click', ()=> onReasonSelected(r));
  sheetList.appendChild(b);
});

let pendingHideCategory = null;
function openSheet(cat){
  pendingHideCategory = cat || null;
  document.body.classList.add('sheet-open');
  sheet.setAttribute('aria-hidden', 'false');
  sheetBackdrop.setAttribute('aria-hidden', 'false');
}
function closeSheet(){
  pendingHideCategory = null;
  document.body.classList.remove('sheet-open');
  sheet.setAttribute('aria-hidden', 'true');
  sheetBackdrop.setAttribute('aria-hidden', 'true');
}
function onReasonSelected(reason){
  // 필요시 서버 로깅 가능
  if(pendingHideCategory) hideCategory(pendingHideCategory);
  closeSheet();
}
btnCancel.addEventListener('click', closeSheet);
sheetBackdrop.addEventListener('click', closeSheet);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSheet(); });

/* ---------- 시작 ---------- */
function go(){ setRealHeight(); loadAll(); }
go();
</script>
</body>
</html>


